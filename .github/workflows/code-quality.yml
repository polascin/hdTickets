name: üéØ Code Quality & PSR Standards

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM

env:
  COMPOSER_ALLOW_SUPERUSER: 1

jobs:
  code-quality:
    name: üîç Code Quality Analysis
    runs-on: ubuntu-24.04
    
    strategy:
      matrix:
        php-version: [8.4]
        dependency-version: [prefer-stable]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üêò Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, redis
          coverage: xdebug
          tools: composer:v2

      - name: üîß Get composer cache directory
        id: composer-cache
        run: |
          echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: üì¶ Cache composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: üì• Install Composer dependencies
        run: |
          composer install --no-progress --prefer-dist --optimize-autoloader --no-suggest

      - name: üìÅ Create storage directories
        run: |
          mkdir -p storage/quality/{logs,coverage/{html,xml},metrics}
          mkdir -p storage/phpstan
          mkdir -p storage/phpunit/cache
          chmod -R 775 storage

      - name: üîç Check PHP Syntax
        run: |
          find . -name "*.php" -not -path "./vendor/*" -not -path "./storage/*" -not -path "./bootstrap/cache/*" -exec php -l {} \; | grep -v "No syntax errors"

      - name: üé® Check PSR-12 Compliance (PHP CS Fixer)
        run: |
          ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php --dry-run --verbose --show-progress=dots

      - name: "üé® Alternative: Check Code Style (Laravel Pint)"
        run: |
          ./vendor/bin/pint --test --verbose

      - name: üî¨ Static Analysis (PHPStan)
        run: |
          ./vendor/bin/phpstan analyse --configuration=phpstan.neon --no-progress

      - name: üß™ Run Tests with Coverage
        run: |
          ./vendor/bin/phpunit --configuration=phpunit.xml --coverage-clover=storage/quality/coverage/clover.xml

      - name: üìä Generate Quality Metrics
        run: |
          ./vendor/bin/phpmetrics --report-html=storage/quality/metrics --report-violations=storage/quality/violations.xml app/

      - name: üìà Upload Coverage to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v3
        with:
          file: ./storage/quality/coverage/clover.xml
          flags: unittests
          name: codecov-umbrella

      - name: üíæ Archive Quality Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports-${{ matrix.php-version }}
          path: |
            storage/quality/
          retention-days: 30

  security-analysis:
    name: üõ°Ô∏è Security Analysis
    runs-on: ubuntu-24.04
    needs: code-quality
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip

      - name: üì• Install Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: üîç Security Audit (Composer)
        run: composer audit

      - name: üîç PHP Security Checker
        uses: symfonycorp/security-checker-action@v5

  namespace-validation:
    name: üìÇ PSR-4 Namespace Validation
    runs-on: ubuntu-24.04
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: üîç Validate PSR-4 Autoloading
        run: |
          # Check if namespaces match directory structure
          find app -name "*.php" -type f | while read file; do
            namespace=$(grep -E '^namespace\s+' "$file" | head -n1 | sed 's/namespace\s\+//' | sed 's/;//')
            if [ ! -z "$namespace" ]; then
              expected_path=$(echo "$namespace" | sed 's/\\/\//g' | sed 's/^App/app/')
              actual_path=$(dirname "$file")
              if [[ "$actual_path" != "$expected_path" ]]; then
                echo "PSR-4 violation in $file:"
                echo "  Expected: $expected_path"
                echo "  Actual:   $actual_path"
                exit 1
              fi
            fi
          done

      - name: üîç Check Autoload Compliance
        run: |
          # Verify composer autoload works correctly
          php -r "
          require 'vendor/autoload.php';
          \$loader = require 'vendor/autoload.php';
          if (!\$loader instanceof \Composer\Autoload\ClassLoader) {
            echo 'Autoloader not working correctly';
            exit(1);
          }
          echo 'PSR-4 autoloading is working correctly';
          "

  performance-analysis:
    name: ‚ö° Performance Analysis
    runs-on: ubuntu-24.04
    needs: code-quality
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath

      - name: üì• Install Dependencies
        run: composer install --optimize-autoloader

      - name: üîç Check for Performance Issues
        run: |
          # Look for common performance anti-patterns
          echo "üîç Checking for performance issues..."
          
          # Check for N+1 query patterns
          grep -r "foreach.*->.*(" app/ | grep -v vendor || echo "No obvious N+1 patterns found"
          
          # Check for inefficient loops
          grep -r "for.*count(" app/ | grep -v vendor || echo "No inefficient count() in loops found"

  notify-quality-status:
    name: üì¢ Quality Status Notification
    runs-on: ubuntu-24.04
    needs: [code-quality, security-analysis, namespace-validation, performance-analysis]
    if: always()
    
    steps:
      - name: üì¢ Notify Success
        if: ${{ needs.code-quality.result == 'success' && needs.security-analysis.result == 'success' && needs.namespace-validation.result == 'success' && needs.performance-analysis.result == 'success' }}
        run: |
          echo "üéâ All quality checks passed!"
          echo "‚úÖ PSR-12 Compliance: PASSED"
          echo "‚úÖ PSR-4 Autoloading: PASSED" 
          echo "‚úÖ Static Analysis: PASSED"
          echo "‚úÖ Security Audit: PASSED"
          echo "‚úÖ Performance Check: PASSED"

      - name: üì¢ Notify Failure
        if: ${{ needs.code-quality.result == 'failure' || needs.security-analysis.result == 'failure' || needs.namespace-validation.result == 'failure' || needs.performance-analysis.result == 'failure' }}
        run: |
          echo "‚ùå Quality checks failed!"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security: ${{ needs.security-analysis.result }}"
          echo "Namespace: ${{ needs.namespace-validation.result }}"  
          echo "Performance: ${{ needs.performance-analysis.result }}"
          exit 1
