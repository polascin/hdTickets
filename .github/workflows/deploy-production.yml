name: Production Deployment Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'
  COMPOSER_CACHE_DIR: ~/.composer/cache

jobs:
  # Security and Code Quality Checks
  security-scan:
    name: Security & Quality Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis
          coverage: none

      - name: Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.COMPOSER_CACHE_DIR }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Security Vulnerabilities Check
        run: composer audit

      - name: PHPStan Static Analysis
        run: vendor/bin/phpstan analyse --memory-limit=2G

      - name: Laravel Pint Code Style Check
        run: vendor/bin/pint --test

  # Automated Testing Suite
  test-suite:
    name: Run Test Suite
    runs-on: ubuntu-latest
    needs: security-scan
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: hdtickets_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis
          coverage: xdebug

      - name: Cache Composer Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.COMPOSER_CACHE_DIR }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Install Dependencies
        run: composer install --optimize-autoloader --no-interaction

      - name: Setup Environment
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:cache

      - name: Run Database Migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: hdtickets_test
          DB_USERNAME: root
          DB_PASSWORD: password

      - name: Seed Test Data
        run: php artisan db:seed --force

      - name: Run PHPUnit Tests
        run: vendor/bin/phpunit --coverage-clover coverage.xml

      - name: Run Feature Tests
        run: php artisan test --parallel --coverage

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: hdtickets-coverage

  # Frontend Asset Building
  build-assets:
    name: Build Frontend Assets
    runs-on: ubuntu-latest
    needs: test-suite
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Build Production Assets
        run: npm run build

      - name: Upload Built Assets
        uses: actions/upload-artifact@v3
        with:
          name: built-assets
          path: public/build/
          retention-days: 1

  # Deployment to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [security-scan, test-suite, build-assets]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Built Assets
        uses: actions/download-artifact@v3
        with:
          name: built-assets
          path: public/build/

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis

      - name: Install Production Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Configure Environment
        run: |
          cp .env.staging .env
          php artisan key:generate --force
          echo "DEPLOYMENT_ID=${{ github.sha }}" >> .env

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/hdtickets-staging
            git pull origin main
            composer install --no-dev --optimize-autoloader
            php artisan config:cache
            php artisan route:cache
            php artisan migrate --force
            php artisan queue:restart
            sudo systemctl reload php8.4-fpm
            sudo systemctl reload nginx

      - name: Run Staging Health Check
        run: |
          sleep 30
          curl -f https://staging.hdtickets.polascin.net/health || exit 1

      - name: Notify Slack - Staging Deployed
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: 'üöÄ Staging deployment successful! Version: ${{ github.sha }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Production Deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment: production
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Built Assets
        uses: actions/download-artifact@v3
        with:
          name: built-assets
          path: public/build/

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis

      - name: Install Production Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Configure Production Environment
        run: |
          cp .env.production .env
          echo "DEPLOYMENT_ID=${{ github.sha }}" >> .env

      - name: Create Deployment Archive
        run: |
          tar -czf hdtickets-${{ github.sha }}.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.github' \
            .

      - name: Upload to Production Server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          source: "hdtickets-${{ github.sha }}.tar.gz"
          target: "/tmp/"

      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          script: |
            # Create backup of current version
            cd /var/www
            if [ -d "hdtickets-current" ]; then
              mv hdtickets-current hdtickets-backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # Extract new version
            mkdir hdtickets-new
            cd hdtickets-new
            tar -xzf /tmp/hdtickets-${{ github.sha }}.tar.gz
            
            # Set permissions
            chmod -R 755 .
            chmod -R 775 storage bootstrap/cache
            chown -R www-data:www-data storage bootstrap/cache
            
            # Database backup
            mysqldump -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE > /backups/db-backup-$(date +%Y%m%d-%H%M%S).sql
            
            # Run migrations
            php artisan migrate --force
            
            # Cache optimization
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Switch to new version
            cd /var/www
            mv hdtickets-new hdtickets-current
            
            # Update symlinks
            ln -sfn /var/www/hdtickets-current /var/www/html
            
            # Restart services
            php artisan queue:restart
            sudo systemctl reload php8.4-fpm
            sudo systemctl reload nginx
            
            # Cleanup
            rm /tmp/hdtickets-${{ github.sha }}.tar.gz

      - name: Run Production Health Check
        run: |
          sleep 60
          curl -f https://hdtickets.polascin.net/health || exit 1

      - name: Notify New Relic of Deployment
        run: |
          curl -X POST "https://api.newrelic.com/v2/applications/${{ secrets.NEW_RELIC_APP_ID }}/deployments.json" \
            -H "Api-Key:${{ secrets.NEW_RELIC_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "deployment": {
                "revision": "${{ github.sha }}",
                "changelog": "Production deployment",
                "description": "Automated deployment via GitHub Actions",
                "user": "github-actions"
              }
            }'

      - name: Notify Sentry of Release
        run: |
          curl -X POST "https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/" \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["hdtickets"],
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }]
            }'

      - name: Notify Slack - Production Deployed
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: 'üéâ Production deployment successful! Version: ${{ github.sha }} üöÄ'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Rollback on Failure
  rollback-on-failure:
    name: Rollback on Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure()
    
    steps:
      - name: Rollback Production Deployment
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          script: |
            cd /var/www
            BACKUP_DIR=$(ls -t | grep hdtickets-backup | head -n1)
            if [ -n "$BACKUP_DIR" ]; then
              mv hdtickets-current hdtickets-failed-$(date +%Y%m%d-%H%M%S)
              mv $BACKUP_DIR hdtickets-current
              ln -sfn /var/www/hdtickets-current /var/www/html
              sudo systemctl reload php8.4-fpm
              sudo systemctl reload nginx
              echo "Rollback completed to: $BACKUP_DIR"
            else
              echo "No backup found for rollback!"
              exit 1
            fi

      - name: Notify Slack - Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: '‚ö†Ô∏è Production deployment failed! Automatic rollback initiated. üîÑ'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
