name: Production Deployment

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '18'
  MYSQL_VERSION: '8.0'
  REDIS_VERSION: '7'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis
          coverage: xdebug

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Security audit
        run: composer audit

      - name: Check for known vulnerabilities
        run: |
          curl -H "Accept: text/plain" https://security.symfony.com/check_lock > security_check.txt
          if [[ -n $(cat security_check.txt) ]]; then
            echo "Security vulnerabilities found:"
            cat security_check.txt
            exit 1
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis
          tools: phpstan

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: PHPStan static analysis
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: PHP CS Fixer
        run: |
          composer require --dev friendsofphp/php-cs-fixer
          ./vendor/bin/php-cs-fixer fix --dry-run --diff

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:${{ env.MYSQL_VERSION }}
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: hdtickets_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:${{ env.REDIS_VERSION }}
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Cache NPM packages
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Setup environment
        run: |
          cp .env.testing .env
          php artisan key:generate
          php artisan config:cache

      - name: Run database migrations
        run: php artisan migrate --force

      - name: Run PHPUnit tests
        run: |
          mkdir -p storage/logs
          ./vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=junit.xml

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            coverage.xml
            junit.xml

  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Artillery
        run: npm install -g artillery

      - name: Run load tests
        run: |
          artillery run tests/load/api-endpoints.yml
          artillery run tests/load/user-scenarios.yml

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, test]
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build for production
        run: |
          composer install --optimize-autoloader --no-dev
          npm ci
          npm run build

      - name: Deploy to staging
        uses: easingthemes/ssh-deploy@v4.1.8
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.STAGING_HOST }}
          REMOTE_USER: ${{ secrets.STAGING_USERNAME }}
          SOURCE: '.'
          TARGET: '/var/www/hdtickets-staging'
          EXCLUDE: |
            /node_modules/
            /tests/
            /storage/logs/
            /.git/
            /.github/

      - name: Run deployment script on staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /var/www/hdtickets-staging
            cp .env.staging .env
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan queue:restart
            sudo systemctl reload nginx

      - name: Health check staging
        run: |
          sleep 30
          curl -f https://staging.hdtickets.polascin.net/health || exit 1

      - name: Notify staging deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: 'Staging deployment completed successfully! ðŸš€'

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, test, load-test, deploy-staging]
    if: github.ref == 'refs/heads/production'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build for production
        run: |
          composer install --optimize-autoloader --no-dev
          npm ci
          npm run build

      - name: Create deployment package
        run: |
          tar -czf hdtickets-${{ github.sha }}.tar.gz \
            --exclude=node_modules \
            --exclude=tests \
            --exclude=storage/logs \
            --exclude=.git \
            --exclude=.github \
            .

      - name: Upload to production server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: 'hdtickets-${{ github.sha }}.tar.gz'
          target: '/tmp/'

      - name: Zero-downtime deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            
            # Deployment variables
            DEPLOY_PATH="/var/www/hdtickets"
            RELEASE_PATH="/var/www/releases/$(date +%Y%m%d%H%M%S)"
            SHARED_PATH="/var/www/shared"
            
            # Create release directory
            mkdir -p $RELEASE_PATH
            
            # Extract release
            cd $RELEASE_PATH
            tar -xzf /tmp/hdtickets-${{ github.sha }}.tar.gz
            rm /tmp/hdtickets-${{ github.sha }}.tar.gz
            
            # Link shared files and directories
            ln -nfs $SHARED_PATH/.env $RELEASE_PATH/.env
            ln -nfs $SHARED_PATH/storage $RELEASE_PATH/storage
            
            # Run deployment commands
            cd $RELEASE_PATH
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Create new symlink (atomic operation)
            ln -nfs $RELEASE_PATH $DEPLOY_PATH.new
            mv $DEPLOY_PATH.new $DEPLOY_PATH
            
            # Restart services
            php artisan queue:restart
            sudo systemctl reload nginx
            sudo systemctl restart php8.4-fpm
            
            # Clean up old releases (keep last 5)
            cd /var/www/releases && ls -t | tail -n +6 | xargs rm -rf

      - name: Health check production
        run: |
          sleep 60
          for i in {1..5}; do
            if curl -f https://hdtickets.polascin.net/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Health check failed, attempt $i/5"
            sleep 10
          done
          exit 1

      - name: Update New Relic deployment
        run: |
          curl -X POST 'https://api.newrelic.com/v2/applications/${{ secrets.NEW_RELIC_APP_ID }}/deployments.json' \
            -H 'X-Api-Key:${{ secrets.NEW_RELIC_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d '{
              "deployment": {
                "revision": "${{ github.sha }}",
                "changelog": "${{ github.event.head_commit.message }}",
                "description": "Production deployment",
                "user": "${{ github.actor }}"
              }
            }'

      - name: Update Sentry release
        run: |
          curl -X POST https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/ \
            -H 'Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["hdtickets"],
              "ref": "${{ github.ref }}",
              "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            }'

      - name: Notify successful deployment
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: |
            ðŸŽ‰ Production deployment successful!
            Version: ${{ github.sha }}
            Deployed by: ${{ github.actor }}
            Health check: âœ… PASSED

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Find previous release
            PREVIOUS=$(ls -t /var/www/releases | head -n 2 | tail -n 1)
            if [ -n "$PREVIOUS" ]; then
              echo "Rolling back to $PREVIOUS"
              ln -nfs /var/www/releases/$PREVIOUS /var/www/hdtickets
              sudo systemctl reload nginx
              sudo systemctl restart php8.4-fpm
            fi

      - name: Notify rollback
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: |
            ðŸš¨ Production deployment failed and was rolled back!
            Version: ${{ github.sha }}
            Please check logs and investigate.
