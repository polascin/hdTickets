# HD Tickets Production SSL Virtual Host Configuration
# Sports Events Entry Tickets Monitoring System - Production SSL Setup with OCSP Stapling
# Author: Lubomir Polascin (Ľubomír Polaščín) aka Walter Csoelle
# Environment: Ubuntu 24.04 LTS, Apache2, PHP8.4, Laravel 12

# Global Security Settings
ServerTokens Prod
ServerSignature Off

# OCSP Stapling Configuration - Global
SSLUseStapling On
SSLStaplingCache "shmcb:/var/run/apache2/ssl_stapling_cache(512000)"
SSLStaplingStandardCacheTimeout 3600
SSLStaplingErrorCacheTimeout 600

# HTTP Virtual Host - Redirect all HTTP traffic to HTTPS
<VirtualHost *:80>
    ServerName hdtickets.local
    ServerAlias www.hdtickets.local
    DocumentRoot /var/www/hdtickets/public
    
    # Security Headers for HTTP requests (before redirect)
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Let's Encrypt ACME Challenge Support
    Alias /.well-known/acme-challenge/ /var/www/hdtickets/public/.well-known/acme-challenge/
    <Directory "/var/www/hdtickets/public/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
    
    # Redirect all HTTP traffic to HTTPS (except ACME challenges)
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
    
    # Log configuration
    ErrorLog ${APACHE_LOG_DIR}/hdtickets-error.log
    CustomLog ${APACHE_LOG_DIR}/hdtickets-access.log combined
</VirtualHost>

# HTTPS Virtual Host - Main SSL Configuration with OCSP Stapling
<VirtualHost *:443>
    ServerName hdtickets.local
    ServerAlias www.hdtickets.local
    DocumentRoot /var/www/hdtickets/public
    
    # SSL Engine Configuration with Let's Encrypt Certificates
    SSLEngine on
    
    # Certificate paths (update for production)
    # For Let's Encrypt certificates, use:
    # SSLCertificateFile /etc/letsencrypt/live/hdtickets.local/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/hdtickets.local/privkey.pem
    
    # For development/testing (current):
    SSLCertificateFile /etc/letsencrypt/live/hdtickets.local/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/hdtickets.local/privkey.pem
    
    # Modern SSL/TLS Configuration - High Security
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # OCSP Stapling Configuration - Per Virtual Host
    SSLUseStapling on
    SSLStaplingReturnResponderErrors off
    SSLStaplingFakeTryLater off
    
    # Certificate Transparency (if supported)
    # SSLCTLogConfig /path/to/ct-log-config.conf
    
    # HTTP/2 Support
    Protocols h2 http/1.1
    
    # Laravel/PHP Configuration
    <Directory /var/www/hdtickets/public>
        Options -Indexes -ExecCGI -Includes
        AllowOverride All
        Require all granted
        
        # Enhanced Security Directives
        <IfModule mod_headers.c>
            # Remove sensitive information
            Header always unset X-Powered-By
            Header always unset Server
            
            # Prevent MIME-type confusion attacks
            Header always set X-Content-Type-Options "nosniff"
        </IfModule>
        
        # Laravel-specific directives
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Handle Laravel routing
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php [QSA,L]
            
            # Security: Block access to sensitive areas
            RewriteRule ^(\.env|\.git|storage|bootstrap/cache) - [F,L]
        </IfModule>
        
        # Security: Deny access to sensitive files and directories
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>
        
        <FilesMatch "\.(env|log|md|sql|json|lock|yaml|yml|ini)$">
            Require all denied
        </FilesMatch>
        
        <DirectoryMatch "(^|/)storage/">
            Require all denied
        </DirectoryMatch>
        
        <DirectoryMatch "(^|/)bootstrap/cache/">
            Require all denied
        </DirectoryMatch>
    </Directory>
    
    # Enhanced Security Headers for HTTPS
    <IfModule mod_headers.c>
        # HSTS with preload list submission
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        
        # Content Security Policy with monitoring
        Header always set Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; connect-src 'self' ws: wss:; frame-src 'none'; frame-ancestors 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; report-uri /csp-report"
        
        # Frame protection
        Header always set X-Frame-Options "DENY"
        
        # XSS protection
        Header always set X-XSS-Protection "1; mode=block"
        
        # Content type protection
        Header always set X-Content-Type-Options "nosniff"
        
        # Referrer policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # Feature policy
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), accelerometer=(), gyroscope=(), magnetometer=()"
        
        # Remove server information
        Header always unset Server
        Header always unset X-Powered-By
        Header always unset X-AspNet-Version
        Header always unset X-AspNetMvc-Version
        
        # Expect-CT header for Certificate Transparency
        Header always set Expect-CT "max-age=86400, enforce, report-uri=\"https://hdtickets.local/ct-report\""
    </IfModule>
    
    # Performance and Caching Headers for Static Assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$">
        # Long-term caching for static assets
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Content-Type-Options "nosniff"
        
        # Enable compression
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
            SetEnvIfNoCase Request_URI \\.(?:gif|jpe?g|png|ico)$ no-gzip dont-vary
        </IfModule>
        
        # Enable Brotli compression if available
        <IfModule mod_brotli.c>
            BrotliCompressionQuality 6
            BrotliFilterNote Input instream
            BrotliFilterNote Output outstream
            BrotliFilterNote Ratio ratio
        </IfModule>
    </LocationMatch>
    
    # API Endpoints Security
    <LocationMatch "^/api/">
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
        Header set Cache-Control "no-cache, no-store, must-revalidate, private"
        Header set Pragma "no-cache"
        Header set Expires "0"
        
        # Rate limiting headers
        Header always set X-RateLimit-Limit "1000"
        Header always set X-RateLimit-Remaining "999"
        Header always set X-RateLimit-Reset "3600"
    </LocationMatch>
    
    # WebSocket Support for Real-time Ticket Updates
    <LocationMatch "^/ws">
        ProxyPreserveHost On
        ProxyPass ws://127.0.0.1:6001/
        ProxyPassReverse ws://127.0.0.1:6001/
        
        # Security headers for WebSocket connections
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
        RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    </LocationMatch>
    
    # Admin Panel Security
    <LocationMatch "^/admin">
        # Additional security for admin areas
        Header always set X-Frame-Options "DENY"
        Header always set Cache-Control "no-cache, no-store, must-revalidate, private"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
        
        # IP whitelisting (uncomment and configure for production)
        # Require ip 192.168.1.0/24
        # Require ip 10.0.0.0/8
    </LocationMatch>
    
    # CSP Reporting Endpoint
    <Location "/csp-report">
        SetHandler "proxy:fcgi://127.0.0.1:9000"
        ProxyFCGISetEnvIf "true" SCRIPT_FILENAME "/var/www/hdtickets/public/index.php"
        ProxyFCGISetEnvIf "true" SCRIPT_NAME "/index.php"
    </Location>
    
    # Certificate Transparency Reporting
    <Location "/ct-report">
        SetHandler "proxy:fcgi://127.0.0.1:9000"
        ProxyFCGISetEnvIf "true" SCRIPT_FILENAME "/var/www/hdtickets/public/index.php"
        ProxyFCGISetEnvIf "true" SCRIPT_NAME "/index.php"
    </Location>
    
    # Health Check Endpoint (no authentication required)
    <Location "/health">
        SetHandler "proxy:fcgi://127.0.0.1:9000"
        ProxyFCGISetEnvIf "true" SCRIPT_FILENAME "/var/www/hdtickets/public/index.php"
        ProxyFCGISetEnvIf "true" SCRIPT_NAME "/index.php"
    </Location>
    
    # Enhanced Logging Configuration
    ErrorLog ${APACHE_LOG_DIR}/hdtickets-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/hdtickets-ssl-access.log combined
    
    # Security-focused Custom Log Format
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{SSL_PROTOCOL}x\" \"%{SSL_CIPHER}x\" \"%{SSL_SESSION_ID}x\" %D" ssl_security
    CustomLog ${APACHE_LOG_DIR}/hdtickets-ssl-security.log ssl_security
    
    # OCSP Status Logging
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{SSL_OCSP_STAPLE}x\"" ocsp_log
    CustomLog ${APACHE_LOG_DIR}/hdtickets-ocsp.log ocsp_log
    
    # Certificate Transparency Logging
    # CustomLog ${APACHE_LOG_DIR}/hdtickets-ct.log "%h %t \"%r\" \"%{SSL_CT_STATUS}x\""
</VirtualHost>

# Global SSL Configuration with OCSP
<IfModule mod_ssl.c>
    # SSL Session Cache
    SSLSessionCache "shmcb:/var/run/apache2/ssl_gcache_data(512000)"
    SSLSessionCacheTimeout 300
    
    # Random seed sources
    SSLRandomSeed startup builtin
    SSLRandomSeed connect builtin
    
    # OCSP Response Configuration
    SSLOCSPDefaultResponder http://ocsp.int-x3.letsencrypt.org
    SSLOCSPOverrideResponder on
    
    # SSL Compression (disabled for security)
    SSLCompression off
    
    # SSL Renegotiation (disabled for security)
    SSLInsecureRenegotiation off
</IfModule>

# Security Module Configuration
<IfModule mod_security2.c>
    # Enhanced ModSecurity rules for Laravel applications
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecRequestBodyLimit 20971520
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject
    
    # Audit logging
    SecAuditEngine RelevantOnly
    SecAuditLog /var/log/apache2/modsec_audit.log
    
    # Disable problematic rules for Laravel
    SecRuleRemoveById 981173 920350 920420
    SecRuleRemoveById 200003 200004
    
    # Custom rules for sports events monitoring
    SecRule REQUEST_HEADERS:User-Agent "@detectSQLi" \
        "id:1001,phase:1,deny,msg:'SQL Injection in User-Agent',logdata:'%{REQUEST_HEADERS.User-Agent}'"
        
    SecRule ARGS "@detectXSS" \
        "id:1002,phase:2,deny,msg:'XSS Attack Detected',logdata:'%{ARGS}'"
</IfModule>

# Performance Optimization
<IfModule mod_deflate.c>
    # Compress text, html, javascript, css, xml
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml application/javascript application/x-javascript
    
    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \
        \\.(?:gif|jpe?g|png|swf|woff|woff2)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \
        \\.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# Enable HTTP/2 Push for critical resources
<IfModule mod_http2.c>
    H2Push on
    H2PushPriority * after
    H2PushPriority text/css before
    H2PushPriority image/png after 32
    H2PushPriority application/javascript interleaved
</IfModule>
