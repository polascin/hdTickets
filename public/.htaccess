# HD Tickets Laravel .htaccess - Optimized
# Sports Events Entry Tickets Monitoring System
# Enhanced URL Rewriting and Security Configuration

<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header for API authentication
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-Forwarded-Proto for HTTPS behind proxy
    RewriteCond %{HTTP:X-Forwarded-Proto} =http [OR]
    RewriteCond %{HTTP:X-Forwarded-Proto} =""
    RewriteCond %{HTTPS} !=on
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Remove trailing slash from non-directories
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Handle Front Controller (Laravel Router)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]

    # Specific handling for sports events API endpoints
    RewriteCond %{REQUEST_URI} ^/api/events
    RewriteRule ^api/(.*)$ index.php [L,QSA]

    # Handle ticket scraping endpoints with rate limiting support
    RewriteCond %{REQUEST_URI} ^/api/scraping
    RewriteRule ^api/(.*)$ index.php [L,QSA,E=SCRAPING_REQUEST:1]
</IfModule>

# Security Headers (backup if not set in Apache config)
<IfModule mod_headers.c>
    # Only set if not already set by Apache
    Header setifempty X-Content-Type-Options "nosniff"
    Header setifempty X-Frame-Options "DENY"
    Header setifempty X-XSS-Protection "1; mode=block"
    Header setifempty Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signatures
    Header always unset Server
    Header always unset X-Powered-By
</IfModule>

# Enhanced Security for sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(env|log|md|sql|json|lock|gitignore|gitattributes|editorconfig)$">
    Require all denied
</FilesMatch>

# Block access to Laravel framework files
<FilesMatch "^(artisan|composer\.(json|lock)|package\.(json|lock)|webpack\.mix\.js|\.env\..*)$">
    Require all denied
</FilesMatch>

# Cache control for static assets (sports events media)
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images for sports events (logos, venue photos)
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    
    # Fonts
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
    
    # JSON APIs (no caching for dynamic ticket data)
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/ld+json "access plus 0 seconds"
</IfModule>

# Compression (if not handled by Apache)
<IfModule mod_deflate.c>
    <IfModule mod_setenvif.c>
        <IfModule mod_headers.c>
            SetEnvIfNoCase ^(Accept-EncodXng|X-cept-Encoding|X{15}|~{15}|-{15})$ ^((gzip|deflate)\s*,?\s*)+|[X~-]{4,13}$ HAVE_Accept-Encoding
            RequestHeader append Accept-Encoding "gzip,deflate" env=HAVE_Accept-Encoding
        </IfModule>
    </IfModule>
</IfModule>

# Enhanced error handling for sports events system
ErrorDocument 400 /index.php
ErrorDocument 401 /index.php
ErrorDocument 403 /index.php
ErrorDocument 404 /index.php
ErrorDocument 500 /index.php
ErrorDocument 503 /index.php

# Charset for proper sports events text display (international events)
AddDefaultCharset UTF-8
